name: Issue Copilot Routing

on:
  issues:
    types: [opened]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  route:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Route issue to Copilot or guidance
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issue = context.payload.issue;
            const issueNumber = issue.number;
            const issueBody = issue.body || '';

            const instructionsPath = path.join(process.cwd(), '.github', 'copilot-instructions.md');
            const instructions = fs.existsSync(instructionsPath)
              ? fs.readFileSync(instructionsPath, 'utf8')
              : '';

            const getSection = (content, header) => {
              const pattern = new RegExp(`^##\\s+${header}\\s*$`, 'm');
              const match = content.match(pattern);
              if (!match) return '';
              const startIndex = match.index + match[0].length;
              const rest = content.slice(startIndex);
              const nextHeaderMatch = rest.match(/^##\s+.+$/m);
              const endIndex = nextHeaderMatch ? startIndex + nextHeaderMatch.index : content.length;
              return content.slice(startIndex, endIndex).trim();
            };

            const applyTemplate = (template, link) => {
              if (!template) return '';
              return template.replace(/\{\{\s*link\s*\}\}/gi, link || '');
            };

            const prTemplate = getSection(instructions, 'PR_COMMENT');
            const nonPrTemplate = getSection(instructions, 'NON_PR_COMMENT');
            const noLinkTemplate = getSection(instructions, 'NO_LINK_COMMENT');

            const linkRegex = /https?:\/\/github\.com\/[^\s)\]]+/gi;
            const links = issueBody.match(linkRegex) || [];
            const latestLink = links.length > 0 ? links[links.length - 1] : '';

            const prMatch = latestLink.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/pull\/(\d+)/i);

            if (!latestLink) {
              const body = applyTemplate(noLinkTemplate, '') || 'Please add a GitHub link to your PR or GitHub page.';
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });
              return;
            }

            if (prMatch) {
              const [, owner, repo, pullNumber] = prMatch;
              const body = applyTemplate(prTemplate, latestLink) || `Found PR link: ${latestLink}. Starting Copilot review.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body
              });

              const labelName = 'copilot-review';
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [labelName]
                });
              } catch (error) {
                try {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: labelName,
                    color: '0e8a16',
                    description: 'Copilot review requested'
                  });
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    labels: [labelName]
                  });
                } catch (innerError) {
                  core.warning(`Unable to add label ${labelName}: ${innerError.message}`);
                }
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: Number(pullNumber),
                body
              });

              return;
            }

            const body = applyTemplate(nonPrTemplate, latestLink) || `Found GitHub link: ${latestLink}. Please provide a PR link.`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });
